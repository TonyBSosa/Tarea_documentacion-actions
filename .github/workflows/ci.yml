name: CI Pipeline B√°sico

# Eventos que disparan este workflow
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite ejecuci√≥n manual desde GitHub UI

# Jobs a ejecutar
jobs:
  # Job 1: Ejecutar Tests
  test:
    name: üß™ Ejecutar Tests
    runs-on: ubuntu-latest
    
    steps:
      
      # Step 1: Hacer checkout del c√≥digo del repositorio
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v3
      
      # Step 2: Configurar Node.js en el runner
      - name: ‚öôÔ∏è Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      # Step 3: Instalar dependencias (si las hay)
      - name: üì¶ Instalar dependencias
        run: npm install
      # Step 3.5: ESLint dentro del CI
      - name: üîç Linting (ESLint)
        run: npm run lint
      
      # Step 4: Ejecutar los tests
      - name: üß™ Ejecutar tests
        run: npm test
      # Step 4: Ejecutar los tests
      - name: üöÄ Deploy simulado a producci√≥n (solo en main)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Iniciando deploy simulado..."
          echo "Rama actual: $GITHUB_REF"
          echo "Compilando assets para producci√≥n..."
          echo "Subiendo build a servidor ficticio..."
          echo "‚úÖ Deploy simulado completado correctamente."

      - name: üìù Generar archivo de log de CI
        run: |
          echo "====================================" > ci-log.txt
          echo "      LOG DE EJECUCI√ìN CI/CD        " >> ci-log.txt
          echo "====================================" >> ci-log.txt
          echo "Fecha: $(date)" >> ci-log.txt
          echo "Commit: $GITHUB_SHA" >> ci-log.txt
          echo "Rama:  $GITHUB_REF" >> ci-log.txt
          echo "Runner OS: $RUNNER_OS" >> ci-log.txt
          echo "------------------------------------" >> ci-log.txt
          echo "Versi√≥n de Node:" >> ci-log.txt
          node -v >> ci-log.txt
          echo "------------------------------------" >> ci-log.txt
          echo "Dependencias instaladas (nivel 0):" >> ci-log.txt
          npm list --depth=0 >> ci-log.txt || echo "No se pudieron listar dependencias" >> ci-log.txt
          echo "====================================" >> ci-log.txt
      - name: ‚¨ÜÔ∏è Subir log como artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-log
          path: ci-log.txt
          retention-days: 7

        
      
      # Step 5: Mostrar informaci√≥n del sistema
      - name: üíª Informaci√≥n del Sistema Operativo
        run: |
          echo "===================================="
          echo "INFORMACI√ìN DEL RUNNER"
          echo "===================================="
          echo "Sistema Operativo: $RUNNER_OS"
          echo "Arquitectura: $RUNNER_ARCH"
          echo "Directorio de trabajo: $GITHUB_WORKSPACE"
          echo "===================================="
          echo "DETALLES DEL SISTEMA"
          echo "===================================="
          uname -a
          echo "===================================="
          echo "VERSIONES DE SOFTWARE"
          echo "===================================="
          node --version
          npm --version
          echo "===================================="
          echo "INFORMACI√ìN DE RECURSOS"
          echo "===================================="
          nproc
          free -h
          df -h

  # Job 2: Build (se ejecuta DESPU√âS de que test pase)
  build:
    name: üèóÔ∏è Build de la Aplicaci√≥n
    needs: test  # Este job depende de que 'test' se complete exitosamente
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v3
      
      - name: ‚öôÔ∏è Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: üì¶ Instalar dependencias
        run: npm install
      
      - name: üèóÔ∏è Ejecutar build
        run: |
          echo "üèóÔ∏è Building application..."
          node index.js
          echo "‚úÖ Build completado exitosamente!"
      
      # Guardar el c√≥digo como artifact para poder descargarlo despu√©s
      - name: üì§ Subir artifact del build
        uses: actions/upload-artifact@v4
        with:
          name: aplicacion-build
          path: |
            index.js
            test.js
            package.json
          retention-days: 5

  # Job 3: Informaci√≥n del workflow (se ejecuta en paralelo con los otros)
  workflow-info:
    name: üìä Informaci√≥n del Workflow
    runs-on: ubuntu-latest
    
    steps:
      - name: üìä Mostrar informaci√≥n del workflow
        run: |
          echo "===================================="
          echo "INFORMACI√ìN DEL WORKFLOW"
          echo "===================================="
          echo "Nombre del repositorio: ${{ github.repository }}"
          echo "Rama: ${{ github.ref }}"
          echo "SHA del commit: ${{ github.sha }}"
          echo "Actor que dispar√≥ el workflow: ${{ github.actor }}"
          echo "Evento que dispar√≥ el workflow: ${{ github.event_name }}"
          echo "N√∫mero de ejecuci√≥n: ${{ github.run_number }}"
          echo "Intento de ejecuci√≥n: ${{ github.run_attempt }}"
          echo "===================================="
